#!/bin/bash

#set -x

#
# make-doc - Simple builder for madoko or latex documents.
#
# A wrapper around madoko + tectonic in order to compile madoko files into pdf
# files via tectonic. This is necessary because madoko has only limited support
# for custom latex-processing commands.
#
# Author: Noah D. Ortiz <ndortiz@caltech.edu>
#

_BUILD_PATH=./build
_TARGET_PATH=./bin

function print_usage()
{
    cat <<EOF
usage: $0 [<options>] -t <type> <input>

Process <input> into a pdf document, placing the output in '${_TARGET_PATH}' and
build material in '${_BUILD_PATH}'.

Where <input> is either a madoko or (la)tex file and <type> is either 'mdk' or
'tex' indicating the filetype of <input>.

Options:
    --help|-h
        Print this usage and exit.
    --preview
        Open the resulting pdf document if it has not already been opened.
    --localtex <path>
        Path to a collection of local tex packages.
EOF
}

function count_open()
{
    path=${1}

    echo $(pgrep -cf "${path}")
}

function preview()
{
    path=${1}

    q="xdg-open[ ]${path}"
    if [ $(count_open "${q}") -eq 0 ]
    then
        xdg-open "${path}" &
    fi
}

# Echo (relative) path to resulting tex.
function mdk_to_tex()
{
    in_path=${1}
    target_path=${2}

    madoko --odir="${target_path}" --tex "${in_path}"

    bn=$(basename --suffix=".mdk" "${in_path}")
    echo "${target_path}/${bn}.tex"
}

# Echo path to resulting pdf.
function tex_to_pdf()
{
    in_path=${1}
    target_path=${2}
    localtex_path=${3}

    build_dir=$(dirname "${in_path}")
    r=$(build_localtex "${localtex_path}" "${build_dir}")
    tectonic --outdir "${target_path}" "${in_path}" &>/dev/stderr

    bn=$(basename --suffix=".tex" "${in_path}")
    echo "${target_path}/${bn}.pdf"
}

function build_localtex()
{
    localtex_path=${1}
    build_path=${2}

    # Do nothing if no localtex to process.
    [ -z ${localtex_path} ] && return
    
    target_path="${build_path}/.localtex"

    # Don't symlink if localtex already exists.
    if [ ! -e "${target_path}" ]; then
        ln -s $(readlink -f "${localtex_path}") "${target_path}" &>/dev/stderr
    fi
}


#
# Main
#

# Default options.
preview=false

# Parse args.
while [ "${#}" -gt 0 ]; do
    case "${1}" in
        --help|-h)
            print_usage
            exit
            ;;
        --preview)
            preview=true
            shift
            ;;
        --localtex)
            shift
            localtex=${1}
            shift
            ;;
        -t)
            shift
            ftype=${1}
            shift
            ;;
        --)
            shift
            ;;
        *)
            input=${1}
            shift
            ;;
    esac
done

# Make directories.
mkdir -p "${_BUILD_PATH}"
mkdir -p "${_TARGET_PATH}"

# Dispatch based on type.
case ${ftype} in
    tex)
        pdf_path=$(tex_to_pdf ${input} ${_TARGET_PATH} ${localtex})
        ;;
    mdk)
        tex_path=$(mdk_to_tex ${input} ${_BUILD_PATH})
        pdf_path=$(tex_to_pdf ${tex_path} ${_TARGET_PATH} ${localtex})
        ;;
    *)
        print_usage
        exit 1
        ;;
esac

# Preview.
if [[ "${preview}" == "true" ]]
then
    preview ${pdf_path}
fi
